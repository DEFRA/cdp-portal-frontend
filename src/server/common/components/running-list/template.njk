{% from "tag/macro.njk" import appTag %}
{% from "time/macro.njk" import appTime %}
{% from "tool-tip/macro.njk" import appToolTip %}
{% from "icons/warning-icon/macro.njk" import appWarningIcon %}
{% from "icons/instance-success-icon/macro.njk" import appInstanceSuccessIcon %}
{% from "icons/instance-failed-icon/macro.njk" import appInstanceFailedIcon %}
{% from "icons/instance-pending-icon/macro.njk" import appInstancePendingIcon %}
{% from "icons/instance-stopped-icon/macro.njk" import appInstanceStoppedIcon %}

<ul class="app-running-list">
  {% for item in params.items %}
    <li class="app-running-list__service">
      <div class="app-running-list__service-heading">
          <h2 class="govuk-heading-l govuk-!-margin-0">{{ item.serviceName }}</h2>
      </div>

      <div class="app-running-list__service-environments">
        {% for envName in params.environments %}
          {% set runningService = item.environments[envName] %}

          {% if runningService %}

            <div class="app-running-list__service-environment{% if runningService.statusClassname %} {{ runningService
            .statusClassname }}{% endif %}">

                {% if runningService.unstable %}
                  <p class="item item-unstable">
                    {{ appWarningIcon({ classes: "app-icon--tiny", description: "Unstable!" }) }}
                      Deployment unstable
                  </p>
                {% endif %}

              <span class="app-running-list__label govuk-visually-hidden">Environment:</span>
              <p class="item item-env">
                {{ appTag({ text: envName | title, classes: "app-tag--grey" }) }}
                - <span>{{ runningService.status | title }}</span>
              </p>

              <p class="item item-version">
                <span class="app-running-list__label">Version:</span>
                  <a class="app-link app-link--text-colour"
                     href="https://github.com/DEFRA/{{ item.serviceName }}/releases/tag/{{ runningService.version }}"
                     target="_blank" rel="noopener noreferrer">
                    {{ runningService.version }}
                  </a>
              </p>

              <p class="item item-instance-count">
                  <span class="app-running-list__label">Instance Count:</span>
                  {{ runningService.instanceCount }}
              </p>

              <p class="item item-cpu">
                <span class="app-running-list__label">CPU:</span>
                {{ runningService.cpu if runningService.cpu else noValue }}
              </p>

              <p class="item item-memory">
                <span class="app-running-list__label">Memory:</span>
                {{ runningService.memory / 1024 + " GB" if runningService.memory  else noValue }}
              </p>



              <p class="item item-instances">
                {% for instanceId, instance in runningService.instances %}
                  {% set tooltipText = "failed" if runningService.unstable === true else instance.status %}

                  <span>
                    {% call appToolTip({
                      text: "Instance " + tooltipText | title,
                      classes: "app-tool-tip--small"
                    }) %}
                      {% if instance.status === "running" %}
                        {{ appInstanceSuccessIcon({ description: "Instance running", classes: "app-icon--small" }) }}
                      {% elseif instance.status === "stopped" and deployment.unstable === true %}
                        {{ appInstanceFailedIcon({ description: "Instance failed to start", classes: "app-icon--small"
                        }) }}
                      {% elseif instance.status === "stopped" %}
                        {{ appInstanceStoppedIcon({ description: "Instance stopped", classes: "app-icon--small" }) }}
                      {% elseif instance.status === "pending"or instance.status === "stopping" or instance.status === "deploying" %}
                        {{ appInstancePendingIcon({ description: "Instance pending", classes: "app-icon--small" }) }}
                      {% endif %}
                    {% endcall %}
                  </span>

                {% endfor %}
              </p>

              <p class="item item-updated">
                <a class="app-link app-link--text-colour"
                   href="/deployments/{{ envName }}/{{ runningService.cdpDeploymentId }}">
                    Deployed
                </a> - <time datetime="{{ runningService.updated }}">
                        {{ runningService.updated | formatDistanceToNow }}
                       </time> ago
              </p>
            </div>

          {% else %}

            <p class="app-running-list__zero-deployment">
              {{ envName | title }}
            </p>

          {% endif %}

        {% endfor %}
      </div>
    </li>
  {% else %}
    <li class="app-running-list__item--no-results">
      <p>No running services found</p>
    </li>
  {% endfor %}
</ul>
